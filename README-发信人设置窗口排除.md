# 发信人设置窗口排除功能

## 🎯 问题描述

在使用ChatMonitor时，有时会出现发信人设置弹框本身被误识别为符合条件的弹框，并触发语音提示的情况。

### 问题原因：
1. **窗口标题匹配**：发信人设置窗口可能包含联系人名称
2. **文本内容匹配**：联系人列表中的文本被误识别
3. **窗口层级问题**：设置窗口可能被当作弹窗处理

## 🛠️ 解决方案

### 1. 自动排除功能

系统现在会自动识别并排除发信人设置窗口，通过以下特征进行识别：

#### 关键词匹配：
- "发信人设置"
- "联系人设置"
- "联系人列表"
- "联系人设置说明"
- "每行输入一个联系人"
- "支持模糊匹配"
- "建议添加常用"
- "修改后点击保存"
- "保存联系人"
- "清空列表"
- "取消"
- "已加载"
- "个联系人"

#### 结构特征匹配：
- 包含"说明"和"联系人"的组合
- 包含"设置"和"联系人"的组合
- 包含"保存"和"联系人"的组合
- 包含"清空"和"列表"的组合

#### 按钮特征匹配：
- "保存联系人"
- "清空列表"
- "取消"

#### 说明文本模式：
- "每行输入" + "联系人"
- "模糊匹配" + "相似度"
- "建议添加" + "常用"

### 2. 工作原理

```python
def is_contacts_settings_window(text):
    """
    检查文本是否为发信人设置窗口
    通过关键词和特征来识别
    """
    # 1. 检查关键词
    # 2. 检查结构特征
    # 3. 检查按钮特征
    # 4. 检查说明文本模式
    # 5. 返回True/False
```

### 3. 检测流程

1. **YOLO检测**：检测屏幕上的弹窗
2. **OCR识别**：对每个弹窗进行文字识别
3. **窗口类型判断**：检查是否为发信人设置窗口
4. **排除处理**：如果是设置窗口，跳过后续处理
5. **正常处理**：如果不是设置窗口，进行联系人匹配

## 📋 测试验证

### 运行测试脚本：
```bash
python3 test_settings_window_exclusion.py
```

### 测试用例：
1. **发信人设置窗口文本** - 应该被识别为设置窗口
2. **正常聊天弹窗文本** - 应该不被识别为设置窗口
3. **包含联系人的正常弹窗** - 应该不被识别为设置窗口
4. **设置窗口关键词测试** - 应该被识别为设置窗口
5. **空文本** - 应该不被识别为设置窗口
6. **只有联系人的文本** - 应该不被识别为设置窗口

## 🔧 配置和调试

### 调试日志

排除功能会记录详细的调试信息到日志文件：
```
/tmp/chatmonitor_debug.log
```

### 日志示例：
```
[DETECTION] 检测到设置窗口关键词: 发信人设置
[DETECTION] 跳过发信人设置窗口: 发信人设置联系人设置说明：每行输入一个联系人姓名...
[DETECTION] 检测到设置窗口结构特征
[DETECTION] 检测到设置窗口按钮
```

### 启用调试模式

在配置文件中设置：
```yaml
debug:
  verbose: true
```

## 🚀 使用方法

### 自动生效

排除功能已经集成到主程序中，无需额外配置，自动生效。

### 验证功能

1. 打开发信人设置窗口
2. 观察监控日志
3. 确认没有触发语音提醒

### 手动测试

```bash
# 运行测试脚本
python3 test_settings_window_exclusion.py

# 查看调试日志
tail -f /tmp/chatmonitor_debug.log
```

## ⚠️ 注意事项

### 1. 关键词更新

如果发信人设置窗口的界面发生变化，可能需要更新关键词列表。

### 2. 误判处理

如果出现误判（正常弹窗被误识别为设置窗口），可以：
- 检查调试日志
- 调整关键词匹配规则
- 联系开发者更新排除逻辑

### 3. 性能影响

排除功能对性能影响很小，主要是文本匹配操作。

## 🔄 更新历史

### v1.0.0
- 初始版本
- 基本关键词匹配
- 结构特征识别

### v1.1.0
- 增强关键词列表
- 添加按钮特征识别
- 添加说明文本模式匹配
- 完善调试日志

## 📞 技术支持

如果遇到问题，请：
1. 查看调试日志
2. 运行测试脚本
3. 提供详细的错误信息
4. 联系开发者 